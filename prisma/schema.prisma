generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  FISCAL
  CFO
}

enum RuleSetStatus {
  DRAFT
  ACTIVE
}

enum DocumentType {
  NFE
}

enum OperationType {
  SALE
  PURCHASE
}

enum TenantPlan {
  FREE
  PRO
  ENTERPRISE
}

enum TelemetryEventType {
  DOCUMENT_UPLOADED
  CALCULATION_EXECUTED
  SCENARIO_APPLIED
  EXPORT_CSV
  EXPORT_XLSX
  ASSISTED_ASSESSMENT_IMPORTED
  DIVERGENCE_JUSTIFIED
}

enum DivergenceStatus {
  OPEN
  JUSTIFIED
  RESOLVED
}

enum TaxType {
  IBS
  CBS
  IS
}

enum CreditLedgerStatus {
  PENDING_EXTINCTION
  AVAILABLE
  CONSUMED
  BLOCKED
}

enum CreditLedgerEventType {
  ACCRUED
  STATUS_CHANGED
  CONSUMED
  ADJUSTED
}

model Tenant {
  id                String                       @id @default(cuid())
  name              String
  plan              TenantPlan                   @default(FREE)
  stripeCustomerId  String?                      @unique
  stripeSubscriptionId String?                   @unique
  stripePriceId     String?
  stripeSubscriptionStatus String?
  stripeCurrentPeriodEnd DateTime?
  createdAt         DateTime                     @default(now())
  users             User[]
  companyProfiles   CompanyProfile[]
  taxRuleSets       TaxRuleSet[]
  productCatalog    ProductCatalog[]
  documents         Document[]
  calcRuns          CalcRun[]
  scenarios         Scenario[]
  legacyRuleSets    LegacyRuleSet[]
  icmsRates         ICMSRate[]
  legacyUfConfigs   LegacyUFConfig[]
  billingUsageRows  BillingUsage[]
  telemetryEvents   TelemetryEvent[]
  taxCreditLedgers  TaxCreditLedger[]
  assistedSnapshots AssistedAssessmentSnapshot[]
  divergences       AssessmentDivergence[]
}

model User {
  id            String    @id @default(cuid())
  tenantId      String
  email         String
  name          String?
  role          UserRole  @default(ADMIN)
  passwordHash  String?
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accounts      Account[]
  sessions      Session[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model CompanyProfile {
  id        String     @id @default(cuid())
  tenantId  String
  legalName String
  cnpj      String?
  uf        String
  segment   String?
  createdAt DateTime   @default(now())
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents Document[]

  @@index([tenantId])
}

model TaxRuleSet {
  id        String        @id @default(cuid())
  tenantId  String
  name      String
  validFrom DateTime
  validTo   DateTime?
  status    RuleSetStatus @default(DRAFT)
  createdAt DateTime      @default(now())
  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rules     TaxRule[]
  calcRuns  CalcRun[]

  @@index([tenantId, status, validFrom, validTo])
}

model TaxRule {
  id          String     @id @default(cuid())
  ruleSetId   String
  priority    Int
  whenJson    Json
  thenJson    Json
  description String
  createdAt   DateTime   @default(now())
  ruleSet     TaxRuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@index([ruleSetId, priority])
}

model ProductCatalog {
  id          String  @id @default(cuid())
  tenantId    String
  ncm         String
  category    String
  description String?
  tenant      Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, ncm])
}

model LegacyRuleSet {
  id        String           @id @default(cuid())
  tenantId  String
  name      String
  validFrom DateTime
  validTo   DateTime?
  status    RuleSetStatus    @default(DRAFT)
  createdAt DateTime         @default(now())
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  icmsRates ICMSRate[]
  ufConfigs LegacyUFConfig[]

  @@index([tenantId, status, validFrom, validTo])
}

model ICMSRate {
  id              String        @id @default(cuid())
  tenantId        String
  legacyRuleSetId String
  uf              String
  ncm             String?
  category        String?
  rate            Decimal       @db.Decimal(8, 6)
  validFrom       DateTime
  validTo         DateTime?
  createdAt       DateTime      @default(now())
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legacyRuleSet   LegacyRuleSet @relation(fields: [legacyRuleSetId], references: [id], onDelete: Cascade)

  @@index([tenantId, uf, validFrom, validTo])
  @@index([legacyRuleSetId])
  @@index([tenantId, ncm])
  @@index([tenantId, category])
}

model LegacyUFConfig {
  id              String        @id @default(cuid())
  tenantId        String
  legacyRuleSetId String
  emitterUf       String
  recipientUf     String
  internalRate    Decimal       @db.Decimal(8, 6)
  interstateRate  Decimal       @db.Decimal(8, 6)
  stRate          Decimal       @default(0) @db.Decimal(8, 6)
  stMva           Decimal       @default(0) @db.Decimal(8, 6)
  difalEnabled    Boolean       @default(true)
  stEnabled       Boolean       @default(false)
  validFrom       DateTime
  validTo         DateTime?
  createdAt       DateTime      @default(now())
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legacyRuleSet   LegacyRuleSet @relation(fields: [legacyRuleSetId], references: [id], onDelete: Cascade)

  @@unique([legacyRuleSetId, emitterUf, recipientUf, validFrom])
  @@index([tenantId, emitterUf, recipientUf, validFrom, validTo])
  @@index([legacyRuleSetId])
}

model Document {
  id               String         @id @default(cuid())
  tenantId         String
  companyProfileId String
  type             DocumentType
  key              String
  issueDate        DateTime
  emitterUf        String
  recipientUf      String
  operationType    OperationType  @default(SALE)
  totalValue       Decimal        @db.Decimal(16, 2)
  rawXmlPath       String?
  createdAt        DateTime       @default(now())
  tenant           Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyProfile   CompanyProfile @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)
  items            DocumentItem[]
  calcRuns         CalcRun[]

  @@unique([tenantId, key])
  @@index([tenantId, issueDate])
}

model DocumentItem {
  id          String           @id @default(cuid())
  documentId  String
  lineNumber  Int
  description String
  ncm         String
  cfop        String?
  category    String?
  quantity    Decimal          @db.Decimal(16, 4)
  unitValue   Decimal          @db.Decimal(16, 4)
  totalValue  Decimal          @db.Decimal(16, 2)
  createdAt   DateTime         @default(now())
  document    Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  results     CalcItemResult[]

  @@index([documentId, lineNumber])
}

model CalcRun {
  id             String            @id @default(cuid())
  tenantId       String
  documentId     String
  ruleSetId      String
  scenarioId     String?
  runAt          DateTime
  parametersJson Json
  createdAt      DateTime          @default(now())
  tenant         Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document       Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  ruleSet        TaxRuleSet        @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
  scenario       Scenario?         @relation(fields: [scenarioId], references: [id], onDelete: SetNull)
  itemResults    CalcItemResult[]
  summary        CalcSummary?
  creditLedgers  TaxCreditLedger[]

  @@index([tenantId, runAt])
  @@index([documentId])
}

model CalcItemResult {
  id             String       @id @default(cuid())
  calcRunId      String
  documentItemId String
  ibsRate        Decimal      @db.Decimal(8, 6)
  cbsRate        Decimal      @db.Decimal(8, 6)
  isRate         Decimal      @default(0) @db.Decimal(8, 6)
  ibsValue       Decimal      @db.Decimal(16, 2)
  cbsValue       Decimal      @db.Decimal(16, 2)
  isValue        Decimal      @default(0) @db.Decimal(16, 2)
  taxBase        Decimal      @db.Decimal(16, 2)
  creditEligible Boolean
  auditJson      Json
  componentsJson Json?
  calcRun        CalcRun      @relation(fields: [calcRunId], references: [id], onDelete: Cascade)
  documentItem   DocumentItem @relation(fields: [documentItemId], references: [id], onDelete: Cascade)

  @@index([calcRunId])
}

model CalcSummary {
  id             String  @id @default(cuid())
  calcRunId      String  @unique
  ibsTotal       Decimal @db.Decimal(16, 2)
  cbsTotal       Decimal @db.Decimal(16, 2)
  isTotal        Decimal @default(0) @db.Decimal(16, 2)
  creditTotal    Decimal @db.Decimal(16, 2)
  effectiveRate  Decimal @db.Decimal(8, 6)
  auditJson      Json
  componentsJson Json?
  calcRun        CalcRun @relation(fields: [calcRunId], references: [id], onDelete: Cascade)
}

model TaxCreditLedger {
  id              String                 @id @default(cuid())
  tenantId        String
  calcRunId       String
  taxType         TaxType
  amount          Decimal                @db.Decimal(16, 2)
  status          CreditLedgerStatus     @default(PENDING_EXTINCTION)
  extDebtRequired Boolean                @default(true)
  evidenceJson    Json?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  tenant          Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  calcRun         CalcRun                @relation(fields: [calcRunId], references: [id], onDelete: Cascade)
  events          TaxCreditLedgerEvent[]

  @@unique([calcRunId, taxType])
  @@index([tenantId, taxType, status, createdAt])
}

model TaxCreditLedgerEvent {
  id           String                @id @default(cuid())
  ledgerId     String
  eventType    CreditLedgerEventType
  amount       Decimal?              @db.Decimal(16, 2)
  metadataJson Json?
  createdAt    DateTime              @default(now())
  ledger       TaxCreditLedger       @relation(fields: [ledgerId], references: [id], onDelete: Cascade)

  @@index([ledgerId, createdAt])
}

model Scenario {
  id             String    @id @default(cuid())
  tenantId       String
  name           String
  parametersJson Json
  createdAt      DateTime  @default(now())
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  calcRuns       CalcRun[]

  @@index([tenantId, createdAt])
}

model BillingUsage {
  id              String   @id @default(cuid())
  tenantId        String
  monthRef        DateTime
  simulationCount Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, monthRef])
}

model TelemetryEvent {
  id        String             @id @default(cuid())
  tenantId  String
  userId    String?
  type      TelemetryEventType
  timestamp DateTime           @default(now())
  payload   Json?
  createdAt DateTime           @default(now())
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, timestamp])
  @@index([tenantId, type, timestamp])
}

model AssistedAssessmentSnapshot {
  id          String                 @id @default(cuid())
  tenantId    String
  monthRef    DateTime
  source      String                 @default("MANUAL")
  importedAt  DateTime               @default(now())
  payloadJson Json
  summaryJson Json
  createdAt   DateTime               @default(now())
  tenant      Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  divergences AssessmentDivergence[]

  @@index([tenantId, monthRef, createdAt])
}

model AssessmentDivergence {
  id             String                     @id @default(cuid())
  tenantId       String
  snapshotId     String
  monthRef       DateTime
  metric         String
  simulatedValue Decimal                    @db.Decimal(16, 4)
  assistedValue  Decimal                    @db.Decimal(16, 4)
  deltaValue     Decimal                    @db.Decimal(16, 4)
  deltaPct       Decimal?                   @db.Decimal(16, 6)
  status         DivergenceStatus           @default(OPEN)
  justification  String?
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  tenant         Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  snapshot       AssistedAssessmentSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@unique([snapshotId, metric])
  @@index([tenantId, monthRef, status, createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
